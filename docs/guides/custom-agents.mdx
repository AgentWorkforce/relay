---
title: "Custom Agents"
description: "Spawn custom CLI tools and configure agent behavior"
---

# Custom Agents

Agent Relay supports any CLI tool as a PTY worker, not just Claude, Codex, and Gemini. Use `spawnPty` to wrap any command.

## Spawning Custom CLIs

### Any command as an agent

```typescript
import { AgentRelay } from "@agent-relay/sdk";

const relay = new AgentRelay();

// Wrap any CLI tool
const agent = await relay.spawnPty({
  name: "Aider",
  cli: "aider",
  args: ["--model", "gpt-4.1"],
});

// Wrap a custom script
const script = await relay.spawnPty({
  name: "Analyzer",
  cli: "python",
  args: ["analyze.py", "--verbose"],
});
```

### Using the low-level client

```typescript
import { AgentRelayClient } from "@agent-relay/sdk";

const client = await AgentRelayClient.start();

await client.spawnPty({
  name: "GooseWorker",
  cli: "goose",
  args: ["--profile", "coding"],
  channels: ["general"],
});
```

## Supported CLI Tools

The broker recognizes certain CLI tools and adds appropriate auto-accept flags:

| CLI | Auto-flags | Notes |
|-----|------------|-------|
| `claude` | `--dangerously-skip-permissions` | Claude Code CLI |
| `codex` | `--full-auto` | OpenAI Codex CLI |
| `gemini` | (defaults) | Gemini CLI |
| `aider` | (none) | Aider coding assistant |
| `goose` | (none) | Goose AI assistant |
| Any command | (none) | Custom CLI tools |

For CLIs without auto-flags, pass the necessary arguments explicitly:

```typescript
const agent = await relay.spawnPty({
  name: "Custom",
  cli: "my-tool",
  args: ["--auto-approve", "--no-confirm"],
});
```

## CLI Arguments

Pass additional arguments to the wrapped CLI:

```typescript
// Claude with specific model
const claude = await relay.claude.spawn({
  name: "Reviewer",
  args: ["--model", "sonnet"],
});

// Codex with custom model
const codex = await relay.codex.spawn({
  name: "Builder",
  args: ["--model", "gpt-4.1"],
});

// Custom CLI with many args
const custom = await relay.spawnPty({
  name: "Worker",
  cli: "my-tool",
  args: ["--config", "prod.json", "--verbose", "--timeout", "300"],
});
```

## Channel Assignment

Assign agents to channels for targeted message delivery:

```typescript
// Backend workers on the backend channel
const api = await relay.spawnPty({
  name: "API",
  cli: "codex",
  channels: ["backend", "general"],
});

// Frontend workers on the frontend channel
const ui = await relay.spawnPty({
  name: "UI",
  cli: "claude",
  channels: ["frontend", "general"],
});

// Send to a specific channel
const human = relay.human({ name: "Lead" });
await human.sendMessage({
  to: "#backend",
  text: "API endpoints need to support pagination",
});
```

If no channels are specified, agents default to `["general"]`.

## Agent Profiles with Claude

When using Claude CLI, you can leverage `.claude/agents/` profile files for specialized behavior:

```typescript
// Spawn Claude with a specific agent profile
const reviewer = await relay.claude.spawn({
  name: "Reviewer",
  args: ["--agent", "reviewer"],
});
```

This loads the agent definition from `.claude/agents/reviewer.md` in your project. The profile can include:

- Model selection
- System prompts
- Allowed tools
- Role-specific behavior

### Example profile

**`.claude/agents/reviewer.md`**
```markdown
---
name: reviewer
description: Code review specialist
model: sonnet
tools: Read, Grep, Glob, Bash
---

# Code Reviewer

You are a code review specialist. Focus on:
- Security vulnerabilities
- Error handling gaps
- Performance concerns
- Type safety issues

Report findings with file paths and line numbers.
```

## Broker Configuration

Configure the broker through the `AgentRelay` constructor:

```typescript
const relay = new AgentRelay({
  // Path to the agent-relay binary (auto-detected by default)
  binaryPath: "/usr/local/bin/agent-relay",

  // Additional broker arguments
  binaryArgs: [],

  // Broker instance name
  brokerName: "my-broker",

  // Default channels for all agents
  channels: ["general", "status"],

  // Working directory for the broker
  cwd: "/path/to/project",

  // Environment variables for the broker
  env: { ...process.env, RELAY_API_KEY: "key" },

  // Request timeout (default: 10s)
  requestTimeoutMs: 15_000,

  // Shutdown timeout (default: 3s)
  shutdownTimeoutMs: 5_000,
});
```

## Monitoring Custom Agents

### Stream PTY output

Watch what your custom agent is doing:

```typescript
const client = await AgentRelayClient.start();

client.onEvent((event) => {
  if (event.kind === "worker_stream" && event.name === "Custom") {
    process.stdout.write(event.chunk);
  }
});
```

### Track lifecycle

```typescript
relay.onAgentSpawned = (agent) => {
  console.log(`${agent.name} started (${agent.runtime})`);
};

relay.onAgentExited = (agent) => {
  console.log(`${agent.name} exited`);
};
```

## Best Practices

<CardGroup cols={2}>
  <Card title="Test CLI First" icon="terminal">
    Run the CLI manually before wrapping it to ensure it works and is authenticated.
  </Card>
  <Card title="Use Auto-Accept Flags" icon="check">
    Pass flags that skip confirmation prompts so the agent can run autonomously.
  </Card>
  <Card title="Name by Role" icon="tag">
    Use descriptive names that reflect the agent's purpose, not the CLI tool.
  </Card>
  <Card title="Channel Isolation" icon="hashtag">
    Use channels to scope communication by domain or team.
  </Card>
</CardGroup>
