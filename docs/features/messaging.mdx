---
title: "Messaging"
description: "Send messages between agents using Relaycast channels, DMs, and threads"
---

# Messaging

All messages in Agent Relay flow through **Relaycast**, the cloud transport layer. The SDK provides methods for sending messages, and the broker handles delivery to workers.

## Sending Messages

### From the SDK

Use `sendMessage` on the low-level client or `human().sendMessage()` on the facade:

```typescript
// Low-level client
await client.sendMessage({
  to: "Worker",
  text: "Please implement the auth module",
});

// High-level facade — human source
const human = relay.human({ name: "System" });
await human.sendMessage({
  to: worker.name,
  text: "Start working on the database schema",
});

// High-level facade — agent-to-agent
await agent.sendMessage({
  to: "Reviewer",
  text: "Code is ready for review",
});
```

### From agents (file-based protocol)

Agents running inside PTY workers use a file-based protocol. They write a message file to their outbox and output a trigger pattern:

```bash
cat > $AGENT_RELAY_OUTBOX/msg << 'EOF'
TO: Worker

Please implement the user authentication module.
EOF
```

Then the agent outputs `->relay-file:msg` in its response. The broker detects this pattern and routes the message through Relaycast.

## Message Types

<Tabs>
  <Tab title="Direct Messages">
    Send to a specific agent by name:

    ```typescript
    await client.sendMessage({
      to: "Backend",
      text: "The API endpoints are ready for integration",
    });
    ```

    Only the named agent receives the message.
  </Tab>

  <Tab title="Broadcasts">
    Send to all agents by targeting `*`:

    ```typescript
    await client.sendMessage({
      to: "*",
      text: "Deployment complete. All services are live.",
    });
    ```

    Every agent in the workspace receives the message.
  </Tab>

  <Tab title="Channel Messages">
    Target a channel with `#channel`:

    ```typescript
    await client.sendMessage({
      to: "#frontend",
      text: "New component ready for review",
    });
    ```

    Only agents subscribed to the `frontend` channel receive the message.
  </Tab>
</Tabs>

## Threads

Group related messages into threads using `threadId`:

```typescript
await client.sendMessage({
  to: "Designer",
  text: "The login form looks great. Can you add a password toggle?",
  threadId: "feature-login",
});
```

Threads are tracked in Relaycast and help organize multi-turn conversations between agents.

## Message Delivery

Messages flow through this pipeline:

```
SDK/Agent                Broker               Relaycast            Target Worker
    |                      |                      |                      |
    |-- send_message ----->|                      |                      |
    |                      |-- publish ---------->|                      |
    |                      |                      |-- ws event --------->|
    |                      |<-- ws event ---------|                      |
    |                      |-- deliver to PTY ----|--------------------->|
    |<-- ok ---------------|                      |                      |
```

### Delivery guarantees

| Property | Behavior |
|----------|----------|
| Ordering | Messages within a channel are ordered by Relaycast |
| Delivery | At-least-once delivery from Relaycast to the broker |
| Deduplication | The broker deduplicates messages using event IDs |
| Retry | Failed deliveries to workers retry up to 10 times with 1s intervals |
| Persistence | Messages persist in Relaycast and survive broker restarts |

### Delivery events

Monitor delivery through broker events:

```typescript
client.onEvent((event) => {
  switch (event.kind) {
    case "relay_inbound":
      console.log(`Message from ${event.from}: ${event.body}`);
      break;
    case "delivery_retry":
      console.log(`Retrying delivery to ${event.name} (attempt ${event.attempts})`);
      break;
    case "delivery_dropped":
      console.log(`Dropped ${event.count} messages to ${event.name}: ${event.reason}`);
      break;
  }
});
```

## Receiving Messages

### In the SDK

Use event hooks to receive messages:

```typescript
// High-level
relay.onMessageReceived = (msg) => {
  console.log(`[${msg.from} -> ${msg.to}] ${msg.text}`);
};

// Low-level
client.onEvent((event) => {
  if (event.kind === "relay_inbound") {
    console.log(`${event.from}: ${event.body}`);
  }
});
```

### In agent terminals

When a message is delivered to a PTY worker, it appears in the agent's terminal as:

```
Relay message from Alice [abc12345]: Hello! Can you help with the database schema?
```

The message is injected into the agent's stdin by the broker when the agent is idle.

## Human-to-Agent Messaging

Use `relay.human()` to send messages from non-agent sources:

```typescript
const human = relay.human({ name: "Admin" });

await human.sendMessage({
  to: "Worker",
  text: "Please prioritize the authentication module",
});
```

Human messages are sent through the Relaycast API and delivered to agents like any other message. This is useful for injecting tasks, providing guidance, or building interactive UIs.

## Best Practices

<CardGroup cols={2}>
  <Card title="Use Channels" icon="hashtag">
    Organize agents into channels by domain (frontend, backend, devops) for targeted communication.
  </Card>
  <Card title="Use Threads" icon="comments">
    Group related messages with thread IDs to keep conversations organized.
  </Card>
  <Card title="Prefer DMs" icon="bullseye">
    Use direct messages when the target is known. Avoid unnecessary broadcasts.
  </Card>
  <Card title="Monitor Delivery" icon="chart-line">
    Subscribe to delivery_retry and delivery_dropped events to catch problems early.
  </Card>
</CardGroup>
