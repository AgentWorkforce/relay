---
title: "SDK Reference"
description: "Complete API reference for @agent-relay/sdk"
---

# SDK Reference

The `@agent-relay/sdk` package provides a TypeScript SDK for spawning, messaging, and orchestrating AI agents through the Agent Relay broker.

## Installation

```bash
npm install @agent-relay/sdk
```

---

## AgentRelay

High-level facade that manages the broker lifecycle and provides a clean, event-driven API.

```typescript
import { AgentRelay } from "@agent-relay/sdk";
```

### Constructor

```typescript
new AgentRelay(options?: AgentRelayOptions)
```

**AgentRelayOptions:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `binaryPath` | `string` | Path to the `agent-relay` binary | Auto-detected |
| `binaryArgs` | `string[]` | Additional arguments for the binary | `[]` |
| `brokerName` | `string` | Name for the broker instance | `"broker"` |
| `channels` | `string[]` | Default channels for agents | `["general"]` |
| `cwd` | `string` | Working directory for the broker | `process.cwd()` |
| `env` | `NodeJS.ProcessEnv` | Environment variables | `process.env` |
| `requestTimeoutMs` | `number` | Timeout for protocol requests | `10000` |
| `shutdownTimeoutMs` | `number` | Timeout for graceful shutdown | `3000` |

### Event Hooks

Assign a callback to handle events, or set to `null` to clear:

```typescript
relay.onMessageReceived: ((msg: Message) => void) | null
relay.onMessageSent: ((msg: Message) => void) | null
relay.onAgentSpawned: ((agent: Agent) => void) | null
relay.onAgentReleased: ((agent: Agent) => void) | null
relay.onAgentExited: ((agent: Agent) => void) | null
```

### Shorthand Spawners

```typescript
relay.codex: AgentSpawner   // Spawns Codex PTY workers
relay.claude: AgentSpawner  // Spawns Claude PTY workers
relay.gemini: AgentSpawner  // Spawns Gemini PTY workers
```

Each spawner has a single method:

```typescript
interface AgentSpawner {
  spawn(options?: {
    name?: string;
    args?: string[];
    channels?: string[];
  }): Promise<Agent>;
}
```

### Methods

#### spawnPty

Spawn a PTY worker wrapping any CLI tool.

```typescript
async spawnPty(input: SpawnPtyInput): Promise<Agent>
```

**SpawnPtyInput:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `name` | `string` | Agent name | Required |
| `cli` | `string` | CLI command to wrap | Required |
| `args` | `string[]` | CLI arguments | `[]` |
| `channels` | `string[]` | Relaycast channels | `["general"]` |

#### human

Create a handle for sending messages from a non-agent source.

```typescript
human(opts: { name: string }): HumanHandle
```

**HumanHandle:**

```typescript
interface HumanHandle {
  readonly name: string;
  sendMessage(input: {
    to: string;
    text: string;
    threadId?: string;
    priority?: number;
  }): Promise<Message>;
}
```

#### listAgents

List all agents managed by the broker.

```typescript
async listAgents(): Promise<Agent[]>
```

#### shutdown

Shut down the broker and all workers.

```typescript
async shutdown(): Promise<void>
```

---

## Agent

Represents a spawned agent. Returned by spawn methods.

```typescript
interface Agent {
  readonly name: string;
  readonly runtime: AgentRuntime;  // "pty" | "headless_claude"
  readonly channels: string[];

  release(): Promise<void>;

  waitForExit(timeoutMs?: number): Promise<"exited" | "timeout" | "released">;

  sendMessage(input: {
    to: string;
    text: string;
    threadId?: string;
    priority?: number;
  }): Promise<Message>;
}
```

### release()

Terminate the agent gracefully. The broker sends a shutdown signal to the worker process.

### waitForExit(timeoutMs?)

Wait for the agent to exit. Returns:

- `"exited"` -- The agent process exited naturally
- `"released"` -- The agent was released (by you or another caller)
- `"timeout"` -- The timeout expired before the agent exited

### sendMessage(input)

Send a message from this agent through Relaycast.

---

## Message

```typescript
interface Message {
  eventId: string;
  from: string;
  to: string;
  text: string;
  threadId?: string;
}
```

---

## AgentRelayClient

Low-level protocol client. Provides direct access to all broker operations.

```typescript
import { AgentRelayClient } from "@agent-relay/sdk";
```

### Static Factory

```typescript
static async start(options?: AgentRelayClientOptions): Promise<AgentRelayClient>
```

### Constructor

```typescript
new AgentRelayClient(options?: AgentRelayClientOptions)
```

**AgentRelayClientOptions:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `binaryPath` | `string` | Path to `agent-relay` binary | Auto-detected |
| `binaryArgs` | `string[]` | Additional binary arguments | `[]` |
| `brokerName` | `string` | Broker instance name | `"broker"` |
| `channels` | `string[]` | Default channels | `["general"]` |
| `cwd` | `string` | Working directory | `process.cwd()` |
| `env` | `NodeJS.ProcessEnv` | Environment variables | `process.env` |
| `requestTimeoutMs` | `number` | Protocol request timeout | `10000` |
| `shutdownTimeoutMs` | `number` | Shutdown timeout | `3000` |
| `clientName` | `string` | Client identifier | `"@agent-relay/sdk-ts"` |
| `clientVersion` | `string` | Client version | `"0.1.0"` |

### Methods

#### start()

Start the broker child process and perform the hello handshake.

```typescript
async start(): Promise<void>
```

#### spawnPty(input)

Spawn a PTY worker.

```typescript
async spawnPty(input: SpawnPtyInput): Promise<{ name: string; runtime: AgentRuntime }>
```

#### spawnHeadlessClaude(input)

Spawn a headless Claude worker (no terminal).

```typescript
async spawnHeadlessClaude(input: SpawnHeadlessClaudeInput): Promise<{ name: string; runtime: AgentRuntime }>
```

**SpawnHeadlessClaudeInput:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `name` | `string` | Agent name | Required |
| `args` | `string[]` | Claude CLI arguments | `[]` |
| `channels` | `string[]` | Relaycast channels | `[]` |

#### release(name)

Release (terminate) a named agent.

```typescript
async release(name: string): Promise<{ name: string }>
```

#### sendMessage(input)

Send a message through the broker.

```typescript
async sendMessage(input: SendMessageInput): Promise<{ event_id: string; targets: string[] }>
```

**SendMessageInput:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `to` | `string` | Target agent, `*` for broadcast, or `#channel` | Required |
| `text` | `string` | Message text | Required |
| `from` | `string` | Sender name override | Broker default |
| `threadId` | `string` | Thread identifier | None |
| `priority` | `number` | Message priority | None |

#### listAgents()

List all agents managed by the broker.

```typescript
async listAgents(): Promise<ListAgent[]>
```

**ListAgent:**

```typescript
interface ListAgent {
  name: string;
  runtime: AgentRuntime;
  channels: string[];
  parent?: string;
  pid?: number;
}
```

#### shutdown()

Send a shutdown command to the broker and wait for the process to exit.

```typescript
async shutdown(): Promise<void>
```

#### waitForExit()

Wait for the broker process to exit.

```typescript
async waitForExit(): Promise<void>
```

### Event Subscriptions

#### onEvent(listener)

Subscribe to broker events. Returns an unsubscribe function.

```typescript
onEvent(listener: (event: BrokerEvent) => void): () => void
```

#### onBrokerStderr(listener)

Subscribe to broker stderr output. Returns an unsubscribe function.

```typescript
onBrokerStderr(listener: (line: string) => void): () => void
```

---

## RelaycastApi

Direct access to the Relaycast HTTP API for human-to-agent messaging.

```typescript
import { RelaycastApi } from "@agent-relay/sdk";
```

### Constructor

```typescript
new RelaycastApi(options?: RelaycastApiOptions)
```

**RelaycastApiOptions:**

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `apiKey` | `string` | Workspace API key | From env or cache |
| `baseUrl` | `string` | Relaycast API URL | `https://api.relaycast.dev` |
| `cachePath` | `string` | Path to cached credentials | `~/.agent-relay/relaycast.json` |
| `agentName` | `string` | Agent name to register with | Random `sdk-<hex>` |

### Static Methods

#### createWorkspace(name, baseUrl?)

Create a new Relaycast workspace.

```typescript
static async createWorkspace(name: string, baseUrl?: string): Promise<RelaycastWorkspace>
```

Returns `{ workspaceId: string; apiKey: string }`.

### Instance Methods

#### sendDm(to, text)

Send a direct message to a named agent.

```typescript
async sendDm(to: string, text: string): Promise<void>
```

#### sendToChannel(channel, text)

Send a message to a channel (without the `#` prefix).

```typescript
async sendToChannel(channel: string, text: string): Promise<void>
```

#### send(to, text)

Send to a target -- prefixed with `#` for channel, otherwise DM.

```typescript
async send(to: string, text: string): Promise<void>
```

#### getMessages(channel, opts?)

Fetch message history from a channel.

```typescript
async getMessages(
  channel: string,
  opts?: { limit?: number; before?: string; after?: string }
): Promise<Array<{ id: string; agent_name: string; text: string; created_at: string }>>
```

---

## Protocol Types

### BrokerEvent

Events emitted by the broker to the SDK.

```typescript
type BrokerEvent =
  | { kind: "agent_spawned"; name: string; runtime: AgentRuntime; parent?: string }
  | { kind: "agent_released"; name: string }
  | { kind: "agent_exited"; name: string; code?: number; signal?: string }
  | { kind: "relay_inbound"; event_id: string; from: string; target: string; body: string; thread_id?: string }
  | { kind: "worker_stream"; name: string; stream: string; chunk: string }
  | { kind: "delivery_retry"; name: string; delivery_id: string; event_id: string; attempts: number }
  | { kind: "delivery_dropped"; name: string; count: number; reason: string }
  | { kind: "acl_denied"; name: string; sender: string; owner_chain: string[] }
```

### AgentRuntime

```typescript
type AgentRuntime = "pty" | "headless_claude";
```

### AgentSpec

Internal specification for spawning an agent.

```typescript
interface AgentSpec {
  name: string;
  runtime: AgentRuntime;
  cli?: string;
  args?: string[];
  channels?: string[];
}
```

### ProtocolEnvelope

The wire format for SDK-broker communication.

```typescript
interface ProtocolEnvelope<TPayload> {
  v: number;           // Always 1
  type: string;
  request_id?: string;
  payload: TPayload;
}
```

### ProtocolError

Error payload from the broker.

```typescript
interface ProtocolError {
  code: string;
  message: string;
  retryable: boolean;
  data?: unknown;
}
```

---

## Error Types

### AgentRelayProtocolError

Thrown when the broker returns a protocol-level error.

```typescript
class AgentRelayProtocolError extends Error {
  code: string;
  retryable: boolean;
  data?: unknown;
}
```

### AgentRelayProcessError

Thrown when the broker process fails (crash, timeout, not found).

```typescript
class AgentRelayProcessError extends Error {}
```

**Example:**

```typescript
import { AgentRelayProtocolError, AgentRelayProcessError } from "@agent-relay/sdk";

try {
  await client.spawnPty({ name: "Worker", cli: "codex" });
} catch (err) {
  if (err instanceof AgentRelayProtocolError) {
    console.log(`Protocol error [${err.code}]: ${err.message}`);
    if (err.retryable) { /* retry */ }
  } else if (err instanceof AgentRelayProcessError) {
    console.log(`Process error: ${err.message}`);
  }
}
```

---

## Utilities

### stripAnsi(s)

Strip ANSI escape sequences from a string.

```typescript
import { stripAnsi } from "@agent-relay/sdk";

const clean = stripAnsi("\x1b[32mHello\x1b[0m");
// "Hello"
```

### cleanLines(raw)

Strip ANSI, split on newlines, trim, and drop empty lines.

```typescript
import { cleanLines } from "@agent-relay/sdk";

const lines = cleanLines(rawPtyOutput);
```

---

## Constants

```typescript
import { PROTOCOL_VERSION } from "@agent-relay/sdk";
// PROTOCOL_VERSION === 1
```
