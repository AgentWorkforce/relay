---
title: API Reference
description: Programmatic API for embedding agent-relay in your applications
---

# API Reference

Agent Relay provides a TypeScript/JavaScript SDK for embedding real-time agent messaging in your applications.

## Installation

```bash
npm install @agent-relay/sdk
```

## Quick Start

```typescript
import { AgentRelayClient } from '@agent-relay/sdk';

// Start the broker and connect
const client = await AgentRelayClient.start({ env: process.env });

// Spawn an agent in a PTY session
await client.spawnPty({
  name: 'Worker',
  cli: 'claude',
  channels: ['general'],
  task: 'Build the REST API',
});

// List connected agents
const agents = await client.listAgents();
console.log(agents);

// Release and shut down
await client.release('Worker');
await client.shutdown();
```

---

## Core Classes

### AgentRelayClient

Low-level client that communicates with the Rust broker via stdio.

```typescript
import { AgentRelayClient } from '@agent-relay/sdk';

const client = await AgentRelayClient.start(options);
```

#### Constructor Options

```typescript
interface AgentRelayClientOptions {
  binaryPath?: string; // Path to agent-relay-broker binary
  binaryArgs?: string[]; // Extra args for broker
  brokerName?: string; // Broker agent name (default: "broker")
  channels?: string[]; // Channels to join (default: ["general"])
  cwd?: string; // Working directory (default: process.cwd())
  env?: NodeJS.ProcessEnv; // Environment variables
  requestTimeoutMs?: number; // Request timeout (default: 10000)
  shutdownTimeoutMs?: number; // Shutdown timeout (default: 3000)
}
```

#### Static Methods

```typescript
// Start broker and return connected client
static async start(options?: AgentRelayClientOptions): Promise<AgentRelayClient>
```

#### Methods

```typescript
// Spawn an agent in a PTY session
async spawnPty(input: SpawnPtyInput): Promise<{ name: string; runtime: AgentRuntime }>

// Spawn a headless Claude agent (API mode)
async spawnHeadlessClaude(input: SpawnHeadlessClaudeInput): Promise<{ name: string; runtime: AgentRuntime }>

// Release an agent
async release(name: string, reason?: string): Promise<{ name: string }>

// Send raw input to an agent's PTY
async sendInput(name: string, data: string): Promise<{ name: string; bytes_written: number }>

// Send a message to an agent or channel
async sendMessage(input: SendMessageInput): Promise<{ event_id: string; targets: string[] }>

// Change an agent's model at runtime
async setModel(name: string, model: string, opts?: { timeoutMs?: number }): Promise<{ name: string; model: string; success: boolean }>

// Get agent metrics (memory, uptime)
async getMetrics(agent?: string): Promise<{ agents: Array<{ name: string; pid: number; memory_bytes: number; uptime_secs: number }> }>

// List all connected agents
async listAgents(): Promise<ListAgent[]>

// Get broker status
async getStatus(): Promise<BrokerStatus>

// Shut down the broker
async shutdown(): Promise<void>

// Wait for the broker process to exit
async waitForExit(): Promise<void>
```

#### Events

```typescript
// Subscribe to broker events
client.onEvent((event: BrokerEvent) => {
  console.log(event.type, event);
});

// Subscribe to broker stderr output
client.onBrokerStderr((line: string) => {
  console.error('[broker]', line);
});
```

---

### AgentRelay

High-level facade with agent lifecycle management and idle detection.

```typescript
import { AgentRelay } from '@agent-relay/sdk';

const relay = new AgentRelay();
```

#### Properties

```typescript
// Event callbacks (assign a function to subscribe)
relay.onMessageReceived: (message: Message) => void;
relay.onAgentSpawned: (agent: Agent) => void;
relay.onAgentReady: (agent: Agent) => void;
relay.onAgentIdle: (event: { name: string; idleSecs: number }) => void;
relay.onAgentExited: (agent: Agent) => void;
relay.onAgentExitRequested: (agent: Agent) => void;
```

#### Methods

```typescript
// Spawn an agent with full lifecycle tracking
async spawnPty(input: SpawnPtyInput & { idleThresholdSecs?: number }): Promise<Agent>

// Create a human handle for sending messages
human(opts: { name: string }): HumanHandle

// List all agents
async listAgents(): Promise<Agent[]>

// Get broker status
async getStatus(): Promise<BrokerStatus>

// Get logs for an agent
async getLogs(agent: string, opts?: { limit?: number; since?: string }): Promise<LogsResult>

// List agents that have logs
async listLoggedAgents(): Promise<string[]>

// Shut down the broker and all agents
async shutdown(): Promise<void>
```

#### CLI Helpers

Convenience methods for common CLIs:

```typescript
// Spawn a Claude agent
const agent = await relay.claude.spawn({ name: 'Worker', task: 'Build feature' });

// Spawn a Codex agent
const agent = await relay.codex.spawn({ name: 'Coder', task: 'Fix bug' });

// Spawn a Gemini agent
const agent = await relay.gemini.spawn({ name: 'Analyst', task: 'Review code' });
```

---

### Agent

Represents a spawned agent with lifecycle management.

```typescript
interface Agent {
  readonly name: string;
  readonly runtime: AgentRuntime;
  readonly channels: string[];
  readonly status: 'spawning' | 'ready' | 'idle' | 'exited';
  exitCode?: number;
  exitSignal?: string;
  exitReason?: string;

  // Release the agent
  release(reason?: string): Promise<void>;

  // Wait for agent to be ready
  waitForReady(timeoutMs?: number): Promise<void>;

  // Wait for agent process to exit
  waitForExit(timeoutMs?: number): Promise<'exited' | 'timeout' | 'released'>;

  // Wait for agent to go idle (no PTY output for threshold duration)
  waitForIdle(timeoutMs?: number): Promise<'idle' | 'timeout' | 'exited'>;

  // Send a message from this agent
  sendMessage(input: { to: string; text: string; threadId?: string }): Promise<Message>;

  // Subscribe to agent PTY output
  onOutput(callback: (chunk: string) => void): () => void;
}
```

---

## Types

### SpawnPtyInput

```typescript
interface SpawnPtyInput {
  name: string; // Agent name
  cli: string; // CLI tool: 'claude', 'codex', 'gemini', 'aider', 'goose'
  args?: string[]; // Extra CLI arguments
  channels?: string[]; // Channels to join
  task?: string; // Initial task to inject
  model?: string; // Model override
  cwd?: string; // Working directory
  team?: string; // Team name
  shadowOf?: string; // Shadow another agent
  shadowMode?: string; // Shadow mode
  idleThresholdSecs?: number; // Idle detection threshold (default: 30, 0 to disable)
}
```

### SendMessageInput

```typescript
interface SendMessageInput {
  to: string; // Target agent, '*' for broadcast, '#channel'
  text: string; // Message text
  from?: string; // Sender name override
  threadId?: string; // Thread ID for threading
  priority?: number; // Message priority
  data?: Record<string, unknown>; // Structured data payload
}
```

### ListAgent

```typescript
interface ListAgent {
  name: string;
  runtime: AgentRuntime; // 'pty' | 'headless_claude'
  channels: string[];
  parent?: string;
  pid?: number;
}
```

### BrokerEvent

```typescript
interface BrokerEvent {
  type: string; // Event type
  agent?: string; // Agent name (if agent-related)
  data?: unknown; // Event-specific data
}
```

Common event types:

- `agent_spawned` — Agent process started
- `agent_ready` — Agent completed initialization
- `agent_idle` — Agent has been silent for threshold duration
- `agent_exited` — Agent process exited
- `delivery_active` — Message being delivered to agent
- `message` — Message received

---

## Examples

### Spawn and Wait for Idle

```typescript
import { AgentRelay } from '@agent-relay/sdk';

const relay = new AgentRelay();

const agent = await relay.spawnPty({
  name: 'Worker',
  cli: 'claude',
  channels: ['general'],
  task: 'Implement user authentication with JWT',
  idleThresholdSecs: 30,
});

// Wait for the agent to finish (goes idle)
const result = await agent.waitForIdle(300_000); // 5 min timeout

if (result === 'idle') {
  console.log('Agent finished work');
} else if (result === 'exited') {
  console.log('Agent exited');
} else {
  console.log('Timed out');
}

await relay.shutdown();
```

### Multi-Agent Coordination

```typescript
import { AgentRelay } from '@agent-relay/sdk';

const relay = new AgentRelay();

// Spawn backend and frontend agents
const backend = await relay.spawnPty({
  name: 'Backend',
  cli: 'claude',
  task: 'Build REST API for user management',
});

const frontend = await relay.spawnPty({
  name: 'Frontend',
  cli: 'codex',
  task: 'Build React dashboard',
});

// Wait for both to be ready
await backend.waitForReady();
await frontend.waitForReady();

// Coordinate via messaging
const human = relay.human({ name: 'Orchestrator' });
await human.sendMessage({
  to: 'Frontend',
  text: 'The API contract is: GET /users, POST /users, PUT /users/:id, DELETE /users/:id',
});

// Wait for completion
await Promise.all([backend.waitForIdle(600_000), frontend.waitForIdle(600_000)]);

await relay.shutdown();
```

### Event Monitoring

```typescript
import { AgentRelayClient } from '@agent-relay/sdk';

const client = await AgentRelayClient.start({ env: process.env });

// Subscribe to all events
const unsub = client.onEvent((event) => {
  switch (event.type) {
    case 'agent_spawned':
      console.log(`Agent spawned: ${event.agent}`);
      break;
    case 'agent_idle':
      console.log(`Agent idle: ${event.agent}`);
      break;
    case 'message':
      console.log(`Message: ${JSON.stringify(event.data)}`);
      break;
  }
});

await client.spawnPty({ name: 'Worker', cli: 'claude', task: 'Hello world' });

// Later: clean up
unsub();
await client.shutdown();
```

---

## Storage

### Storage Adapter

Message persistence uses a pluggable adapter interface:

```typescript
interface StorageAdapter {
  init(): Promise<void>;
  saveMessage(message: StoredMessage): Promise<void>;
  getMessages(query: MessageQuery): Promise<StoredMessage[]>;
  getMessageById(id: string): Promise<StoredMessage | null>;
  close(): Promise<void>;
}
```

Available adapters:

- **JSONL** (default) — Append-only log files in `.agent-relay/messages/`
- **Memory** — Volatile fallback for tests or when persistence fails

---

## Environment Variables

| Variable                     | Default                     | Description                        |
| ---------------------------- | --------------------------- | ---------------------------------- |
| `RELAY_AGENT_NAME`           | —                           | Agent name for broker registration |
| `RELAY_API_KEY`              | —                           | Relaycast workspace API key        |
| `RELAY_BASE_URL`             | `https://api.relaycast.dev` | Relaycast API base URL             |
| `RELAY_CHANNELS`             | `general`                   | Comma-separated channel list       |
| `AGENT_RELAY_DASHBOARD_PORT` | `3888`                      | Dashboard HTTP port                |
| `AGENT_RELAY_BIN`            | bundled                     | Override broker binary path        |
| `RUST_LOG`                   | —                           | Rust log level for broker          |
