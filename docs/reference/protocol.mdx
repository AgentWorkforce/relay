---
title: "Protocol Reference"
description: "Specification for the stdio JSON protocol between the SDK and broker"
---

# Protocol Reference

The SDK and broker communicate over **stdio** using newline-delimited JSON envelopes. This document specifies the envelope format, request types, event types, and error model.

## Protocol Version

Current protocol version: **1**

The version is included in every envelope and checked during the hello handshake.

---

## Wire Format

Each message is a single line of JSON written to stdin (SDK to broker) or stdout (broker to SDK), terminated by a newline character.

```
{"v":1,"type":"hello","request_id":"req_1","payload":{...}}\n
```

There is no length prefix or binary framing. Each line is a complete JSON object.

---

## Envelope Structure

Every message is wrapped in a protocol envelope:

```typescript
interface ProtocolEnvelope<TPayload> {
  v: number;           // Protocol version (always 1)
  type: string;        // Message type
  request_id?: string; // Correlates requests with responses
  payload: TPayload;   // Type-specific data
}
```

### Example

```json
{
  "v": 1,
  "type": "spawn_agent",
  "request_id": "req_3",
  "payload": {
    "agent": {
      "name": "Worker",
      "runtime": "pty",
      "cli": "codex",
      "args": [],
      "channels": ["general"]
    }
  }
}
```

---

## Request Types (SDK to Broker)

### hello

Initiate the protocol handshake. Must be the first message sent.

```typescript
{
  type: "hello";
  payload: {
    client_name: string;     // e.g., "@agent-relay/sdk-ts"
    client_version: string;  // e.g., "0.1.0"
  };
}
```

### spawn_agent

Spawn a new worker agent.

```typescript
{
  type: "spawn_agent";
  payload: {
    agent: {
      name: string;
      runtime: "pty" | "headless_claude";
      cli?: string;        // CLI to wrap (PTY only)
      args?: string[];     // Additional CLI arguments
      channels?: string[]; // Relaycast channels to subscribe
    };
  };
}
```

### send_message

Send a message through Relaycast.

```typescript
{
  type: "send_message";
  payload: {
    to: string;          // Target agent, "*", or "#channel"
    text: string;        // Message content
    from?: string;       // Sender name override
    thread_id?: string;  // Thread identifier
    priority?: number;   // Message priority
  };
}
```

### release_agent

Release (terminate) a named agent.

```typescript
{
  type: "release_agent";
  payload: {
    name: string;   // Agent to release
  };
}
```

### list_agents

List all agents managed by the broker.

```typescript
{
  type: "list_agents";
  payload: {};
}
```

### shutdown

Initiate a graceful broker shutdown.

```typescript
{
  type: "shutdown";
  payload: {};
}
```

---

## Response Types (Broker to SDK)

### hello_ack

Response to the `hello` handshake.

```typescript
{
  type: "hello_ack";
  payload: {
    broker_version: string;    // Broker version string
    protocol_version: number;  // Protocol version (1)
  };
}
```

### ok

Successful response to a request. The `result` field contains type-specific data.

```typescript
{
  type: "ok";
  payload: {
    result: unknown;  // Request-specific result
  };
}
```

**Result shapes by request type:**

| Request | Result |
|---------|--------|
| `spawn_agent` | `{ name: string; runtime: "pty" \| "headless_claude" }` |
| `release_agent` | `{ name: string }` |
| `send_message` | `{ event_id: string; targets: string[] }` |
| `list_agents` | `{ agents: ListAgent[] }` |
| `shutdown` | `{}` |

### error

Error response to a request.

```typescript
{
  type: "error";
  payload: {
    code: string;       // Error code
    message: string;    // Human-readable description
    retryable: boolean; // Whether the request can be retried
    data?: unknown;     // Additional error context
  };
}
```

### event

Asynchronous event from the broker. Has no `request_id`.

```typescript
{
  type: "event";
  payload: BrokerEvent;
}
```

---

## Event Types

Events are delivered asynchronously from the broker to the SDK. They have no `request_id` and do not require a response.

### agent_spawned

A worker was created.

```typescript
{
  kind: "agent_spawned";
  name: string;           // Agent name
  runtime: AgentRuntime;  // "pty" | "headless_claude"
  parent?: string;        // Parent agent name (if spawned by another agent)
}
```

### agent_released

A worker was released via the SDK.

```typescript
{
  kind: "agent_released";
  name: string;   // Agent name
}
```

### agent_exited

A worker process exited.

```typescript
{
  kind: "agent_exited";
  name: string;      // Agent name
  code?: number;     // Exit code (if available)
  signal?: string;   // Signal name (if killed by signal)
}
```

### relay_inbound

An incoming message was received from Relaycast.

```typescript
{
  kind: "relay_inbound";
  event_id: string;     // Relaycast event ID
  from: string;         // Sender name
  target: string;       // Target agent name
  body: string;         // Message text
  thread_id?: string;   // Thread identifier
}
```

### worker_stream

PTY output from a worker. Emitted in real-time as the worker produces output.

```typescript
{
  kind: "worker_stream";
  name: string;    // Agent name
  stream: string;  // "stdout" or "stderr"
  chunk: string;   // Raw output text (may contain ANSI escapes)
}
```

### delivery_retry

A message delivery to a worker was retried.

```typescript
{
  kind: "delivery_retry";
  name: string;         // Target agent
  delivery_id: string;  // Delivery identifier
  event_id: string;     // Original event ID
  attempts: number;     // Number of attempts so far
}
```

### delivery_dropped

Messages to a worker were dropped (e.g., queue overflow).

```typescript
{
  kind: "delivery_dropped";
  name: string;    // Target agent
  count: number;   // Number of messages dropped
  reason: string;  // Reason for dropping
}
```

### acl_denied

A message was blocked by access control rules.

```typescript
{
  kind: "acl_denied";
  name: string;           // Target agent
  sender: string;         // Blocked sender
  owner_chain: string[];  // Ownership chain of the target
}
```

---

## Worker Protocol

The broker communicates with workers (PTY and headless) using a separate protocol over their stdin/stdout. This is an internal protocol not typically used by SDK consumers.

### Broker to Worker

| Type | Description |
|------|-------------|
| `init_worker` | Initialize the worker with agent specification |
| `deliver_relay` | Deliver an incoming message |
| `shutdown_worker` | Request graceful shutdown |
| `ping` | Health check |

### Worker to Broker

| Type | Description |
|------|-------------|
| `worker_ready` | Worker is initialized and ready |
| `delivery_ack` | Acknowledge message delivery |
| `worker_stream` | Output chunk (stdout/stderr) |
| `worker_error` | Error report |
| `worker_exited` | Worker is exiting |
| `pong` | Health check response |

---

## Request/Response Flow

Every request from the SDK includes a `request_id`. The broker responds with the same `request_id` so the SDK can match responses to requests.

```
SDK                          Broker
 |                              |
 |-- hello (req_1) ----------->|
 |<- hello_ack (req_1) --------|
 |                              |
 |-- spawn_agent (req_2) ----->|
 |<- ok (req_2) ---------------|
 |                              |
 |<- event (no req_id) --------|  agent_spawned
 |<- event (no req_id) --------|  worker_stream
 |<- event (no req_id) --------|  relay_inbound
 |                              |
 |-- send_message (req_3) ---->|
 |<- ok (req_3) ---------------|
 |                              |
 |-- shutdown (req_4) -------->|
 |<- ok (req_4) ---------------|
 |                       [process exits]
```

Events flow independently of request/response pairs and can arrive at any time after the handshake.

---

## Error Codes

| Code | Description | Retryable |
|------|-------------|-----------|
| `invalid_request` | Malformed or invalid request | No |
| `agent_not_found` | Named agent does not exist | No |
| `agent_already_exists` | Agent with that name already exists | No |
| `spawn_failed` | Failed to spawn worker process | Yes |
| `delivery_failed` | Failed to deliver message | Yes |
| `internal_error` | Internal broker error | Yes |
| `shutdown_in_progress` | Broker is shutting down | No |
