version: '1.0'
name: test-trajectory-quality
description: >
  Verifies that trajectory files capture reasoning (purpose, step intent,
  failure diagnosis) not just mechanical event logs. Designed to partially
  fail so verification_mismatch classification is exercised.

swarm:
  pattern: dag
  channel: test-traj-quality
  timeoutMs: 300000

agents:
  - name: worker
    cli: claude
    preset: worker
    constraints:
      model: haiku

workflows:
  - name: trajectory-quality
    onError: continue

    steps:
      - name: work
        type: agent
        agent: worker
        task: 'Output exactly: WORK_DONE'
        verification:
          type: output_contains
          value: WORK_DONE

      - name: fail-known
        type: agent
        agent: worker
        dependsOn: [work]
        task: 'Output exactly: TASK_COMPLETE'
        verification:
          type: output_contains
          value: SENTINEL_NEVER_EMITTED

      - name: check-trajectory
        type: deterministic
        dependsOn: [work]
        # Search across all trajectory files for any that belong to THIS workflow
        # (identified by the workflow name in the task title). Old runs in the
        # directory don't interfere â€” we find the one that matches this run.
        command: >-
          node -e "
          const fs=require('fs');
          const dirs=['.trajectories/active','.trajectories/completed'];
          const files=dirs.flatMap(d=>fs.existsSync(d)?fs.readdirSync(d).filter(f=>f.endsWith('.json')).map(f=>d+'/'+f):[]);
          if(!files.length){console.error('No trajectory files found');process.exit(1);}
          const parsed=files.map(f=>{try{return JSON.parse(fs.readFileSync(f,'utf8'));}catch{return null;}}).filter(Boolean);
          const t=parsed.find(x=>x.task&&x.task.title&&x.task.title.includes('traj-quality'));
          if(!t){console.error('No trajectory for this run. Titles:',parsed.map(x=>x.task&&x.task.title));process.exit(1);}
          const events=t.chapters.flatMap(c=>c.events);
          const has=s=>events.some(e=>e.content.includes(s));
          if(!has('Verifies that trajectory')){console.error('FAIL: no purpose event. Events:',events.slice(0,5).map(e=>e.content));process.exit(1);}
          console.log('PASS purpose');
          if(!has('Output exactly')){console.error('FAIL: no step intent event');process.exit(1);}
          console.log('PASS step intent');
          if(!has('WORK_DONE')){console.error('FAIL: completion sentinel missing');process.exit(1);}
          console.log('PASS sentinel');
          const r=t.retrospective||{};
          if(!r.approach||r.approach==='workflow-runner DAG execution'){console.error('FAIL: approach='+r.approach);process.exit(1);}
          console.log('PASS approach:',r.approach);
          console.log('TRAJECTORY_QUALITY_PASS');
          "
        captureOutput: true
        failOnError: true
