version: '1.0'
name: clean-step-output
description: >
  Fix the noisy step output posted to Relaycast channels.
  Current problem: PTY-captured output from interactive claude/codex agents
  gets posted to the channel as 37 chunks of raw TUI chrome — spinner chars,
  box-drawing, "thinking" animations, system-reminder blocks, cursor artifacts.
  This is unreadable and floods the channel.

  Claude analyst identifies exactly what to strip and what to keep.
  Codex implementer rewrites scrubForChannel + persistStepOutput in runner.ts.
  Claude reviewer validates the changes compile and the output is clean.

swarm:
  pattern: pipeline
  maxConcurrency: 1
  timeoutMs: 1200000 # 20 min
  channel: clean-output
  idleNudge:
    nudgeAfterMs: 300000
    escalateAfterMs: 120000
    maxNudges: 2

agents:
  - name: analyst
    cli: claude
    interactive: false # Non-interactive: reads files, writes spec to disk, exits. No relay needed.
    channels: [clean-output]
    role: >
      Reads runner.ts and writes a scrubbing spec to /tmp/clean-output-spec.md.
      Does NOT spawn sub-agents. Runs as a one-shot subprocess.
    constraints:
      model: sonnet

  - name: implementer
    cli: codex
    interactive: false
    channels: [clean-output]
    role: >
      Rewrites scrubForChannel and persistStepOutput in runner.ts based on the
      analyst's spec. Produces clean, readable channel posts.
    constraints:
      model: gpt-5.3-codex

  - name: reviewer
    cli: claude
    interactive: false # Non-interactive: reads updated file, verifies, exits.
    channels: [clean-output]
    role: >
      Reads the updated runner.ts, verifies the logic, confirms build passes.
      Does NOT spawn sub-agents.
    constraints:
      model: sonnet

workflows:
  - name: fix-step-output-noise
    steps:
      # ── Step 1: Analyst reads the code and produces a spec ──────────────────

      - name: analyze
        type: agent
        agent: analyst
        task: |
          Read these two files in full:
            packages/sdk/src/workflows/runner.ts

          Find the methods:
            - scrubForChannel (around line 2982)
            - persistStepOutput (around line 2997)

          Also read what a real noisy output looks like. The problems are:
          1. Unicode TUI spinners: ✢ ✶ ✳ ✻ ✽ ✾ ◦ • ▗ ▖ ▘ ▝ ⏵ ⏶ ⏷ ⏸ ⏹
          2. "thinking" / "Musing" / "Working" animation lines with these chars
          3. Claude TUI header block (Claude Code vX.X.XX, Sonnet X.X lines)
          4. Box-drawing lines (────── repeated, ═══ etc.)
          5. system-reminder XML blocks (<system-reminder>...</system-reminder>)
          6. Cursor/terminal artifacts (sequences like ❯, ⎿, control chars after ANSI strip)
          7. MCP tool call JSON blobs (large JSON from relay MCP calls)
          8. Lines that are purely whitespace or a single character
          9. "Press up to edit queued messages" / "tab to queue message" UI hints
          10. Relay message injection headers that got into the PTY buffer

          Produce a SCRUB_SPEC with:
          A. Exact regex patterns to remove each noise category
          B. A rule for what lines to KEEP (must contain real alphanumeric content
             that is NOT one of the above categories)
          C. Whether to post PTY output to channel at all, or just a one-line
             completion notice ("Step X completed — output written to disk")
          D. How to handle non-interactive agent stdout (keep it — it's already clean)

          Write the spec to: /tmp/clean-output-spec.md

          IMPORTANT: Do NOT use relay_spawn, add_agent, or any tool to spawn
          sub-agents. Complete this task entirely yourself.

          Output: ANALYSIS_DONE
        verification:
          type: output_contains
          value: ANALYSIS_DONE

      # ── Step 2: Codex implements the fix ────────────────────────────────────

      - name: implement
        type: agent
        agent: implementer
        dependsOn: [analyze]
        task: |
          Read the spec from /tmp/clean-output-spec.md
          Read packages/sdk/src/workflows/runner.ts

          Rewrite the following two methods:

          1. scrubForChannel(text: string): string
             Located around line 2982 in runner.ts.
             Must aggressively clean PTY output:
             - Strip all ANSI/VT escape codes (already done by stripAnsiFn)
             - Remove lines containing ONLY: whitespace, spinner chars, box-drawing
             - Remove <system-reminder>...</system-reminder> blocks entirely
             - Remove MCP JSON tool call blobs (lines starting with { or large
               JSON objects that span multiple lines)
             - Remove claude TUI header lines (Claude Code vX, Sonnet X.X etc.)
             - Remove UI hints ("Press up to edit", "tab to queue", "bypass permissions")
             - Remove lines with "thinking", "Musing", "Working" + only spinner chars
             - Keep lines that have meaningful alphanumeric content
             - Collapse 3+ blank lines to 1
             - Trim leading/trailing whitespace from result

          2. persistStepOutput(runId, stepName, output): Promise<void>
             Located around line 2997 in runner.ts.
             Change the channel posting strategy:
             - Always write full ANSI-stripped output to disk (unchanged — needed for step chaining)
             - For channel post: use scrubForChannel, then if result is still > 2000 chars,
               only post the last 2000 chars (most recent = most relevant)
             - Cap at 1 chunk max — never post more than 1 message per step output
             - If scrubbed output is empty (all chrome, no content), post:
               "**[stepName]** Step completed — output written to disk"

          Edit packages/sdk/src/workflows/runner.ts directly with these changes.
          Do not change anything else in the file.
          Do NOT spawn sub-agents or use relay tools.

          Output: IMPLEMENTATION_DONE
        verification:
          type: output_contains
          value: IMPLEMENTATION_DONE

      # ── Step 3: Build ────────────────────────────────────────────────────────

      - name: build
        type: deterministic
        dependsOn: [implement]
        command: npm run build:sdk 2>&1
        captureOutput: true
        failOnError: false

      # ── Step 4: Reviewer validates ───────────────────────────────────────────

      - name: review
        type: agent
        agent: reviewer
        dependsOn: [build]
        task: |
          Build output:
          {{steps.build.output}}

          If the build failed, read packages/sdk/src/workflows/runner.ts and fix
          any TypeScript errors yourself. Re-run: npm run build:sdk

          If the build passed, verify:
          1. scrubForChannel strips TUI chrome but keeps real content lines
          2. persistStepOutput still writes full ANSI-stripped output to disk
          3. The channel post is capped at 1 message (no more chunks)
          4. Non-interactive agent stdout is still posted as-is (it's already clean)

          Read the updated runner.ts methods and confirm each point above.

          Do NOT spawn sub-agents or use relay tools.

          If everything looks correct, output: REVIEW_PASSED
          If there are issues, fix them directly in runner.ts and rebuild first.
        verification:
          type: output_contains
          value: REVIEW_PASSED
