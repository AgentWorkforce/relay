{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "RelayYamlConfig",
  "title": "Relay YAML Configuration",
  "description": "Schema for relay.yaml workflow configuration files",
  "type": "object",
  "required": ["version", "name", "swarm", "agents"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration schema version"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for this relay configuration"
    },
    "description": {
      "type": "string",
      "description": "Optional description of the configuration"
    },
    "swarm": {
      "$ref": "#/definitions/SwarmConfig"
    },
    "agents": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/AgentDefinition"
      },
      "minItems": 1
    },
    "workflows": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/WorkflowDefinition"
      }
    },
    "coordination": {
      "$ref": "#/definitions/CoordinationConfig"
    },
    "state": {
      "$ref": "#/definitions/StateConfig"
    },
    "errorHandling": {
      "$ref": "#/definitions/ErrorHandlingConfig"
    }
  },
  "definitions": {
    "SwarmConfig": {
      "type": "object",
      "required": ["pattern"],
      "additionalProperties": false,
      "properties": {
        "pattern": {
          "$ref": "#/definitions/SwarmPattern"
        },
        "maxConcurrency": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of agents running concurrently"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Global swarm timeout in milliseconds"
        },
        "channel": {
          "type": "string",
          "description": "Default relay channel for agent communication"
        }
      }
    },
    "SwarmPattern": {
      "type": "string",
      "enum": [
        "fan-out",
        "pipeline",
        "hub-spoke",
        "consensus",
        "mesh",
        "handoff",
        "cascade",
        "dag",
        "debate",
        "hierarchical",
        "map-reduce",
        "scatter-gather",
        "supervisor",
        "reflection",
        "red-team",
        "verifier",
        "auction",
        "escalation",
        "saga",
        "circuit-breaker",
        "blackboard",
        "swarm"
      ]
    },
    "AgentDefinition": {
      "type": "object",
      "required": ["name", "cli"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique agent name within the workflow"
        },
        "cli": {
          "$ref": "#/definitions/AgentCli"
        },
        "role": {
          "type": "string",
          "description": "Agent role description"
        },
        "task": {
          "type": "string",
          "description": "Default task assigned to the agent"
        },
        "channels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Relay channels the agent should join"
        },
        "constraints": {
          "$ref": "#/definitions/AgentConstraints"
        },
        "interactive": {
          "type": "boolean",
          "default": true,
          "description": "When false, the agent runs as a non-interactive subprocess (no PTY, no relay messaging). It receives its task as a CLI prompt argument and returns stdout as output. Default: true."
        }
      }
    },
    "AgentCli": {
      "type": "string",
      "enum": ["claude", "codex", "gemini", "aider", "goose", "opencode", "droid"]
    },
    "AgentConstraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "maxTokens": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum token budget for the agent"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Per-agent timeout in milliseconds"
        },
        "retries": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of retry attempts on failure"
        },
        "model": {
          "type": "string",
          "description": "Model override for the agent"
        }
      }
    },
    "WorkflowDefinition": {
      "type": "object",
      "required": ["name", "steps"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique workflow name"
        },
        "description": {
          "type": "string"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/WorkflowStep"
          },
          "minItems": 1
        },
        "onError": {
          "type": "string",
          "enum": ["fail", "skip", "retry"],
          "description": "Error handling strategy for this workflow"
        }
      }
    },
    "WorkflowStep": {
      "type": "object",
      "required": ["name", "agent", "task"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique step name within the workflow"
        },
        "agent": {
          "type": "string",
          "description": "Name of the agent to execute this step"
        },
        "task": {
          "type": "string",
          "description": "Task description for the agent"
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step names that must complete before this step runs"
        },
        "verification": {
          "$ref": "#/definitions/VerificationCheck"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0
        },
        "retries": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "VerificationCheck": {
      "type": "object",
      "required": ["type", "value"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["output_contains", "exit_code", "file_exists", "custom"],
          "description": "Type of verification to perform"
        },
        "value": {
          "type": "string",
          "description": "Expected value or expression for verification"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what is being verified"
        }
      }
    },
    "CoordinationConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "barriers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Barrier"
          }
        },
        "votingThreshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of agents required for voting (0-1)"
        },
        "consensusStrategy": {
          "type": "string",
          "enum": ["majority", "unanimous", "quorum"],
          "description": "Strategy for reaching consensus among agents"
        }
      }
    },
    "Barrier": {
      "type": "object",
      "required": ["name", "waitFor"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique barrier name"
        },
        "waitFor": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Agent or step names to wait for before proceeding"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Timeout for the barrier in milliseconds"
        }
      }
    },
    "StateConfig": {
      "type": "object",
      "required": ["backend"],
      "additionalProperties": false,
      "properties": {
        "backend": {
          "type": "string",
          "enum": ["memory", "redis", "database"],
          "description": "State storage backend"
        },
        "ttlMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Time-to-live for state entries in milliseconds"
        },
        "namespace": {
          "type": "string",
          "description": "Namespace prefix for state keys"
        }
      }
    },
    "ErrorHandlingConfig": {
      "type": "object",
      "required": ["strategy"],
      "additionalProperties": false,
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["fail-fast", "continue", "retry"],
          "description": "Global error handling strategy"
        },
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of retries"
        },
        "retryDelayMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Delay between retries in milliseconds"
        },
        "notifyChannel": {
          "type": "string",
          "description": "Relay channel to notify on errors"
        }
      }
    }
  }
}
