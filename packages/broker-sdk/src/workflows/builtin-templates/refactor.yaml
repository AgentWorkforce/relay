version: "1.0"
name: refactor
description: "Hierarchical refactor workflow for safe structural improvement."
swarm:
  pattern: hierarchical
  maxConcurrency: 2
  timeoutMs: 4500000
  channel: swarm-refactor
agents:
  - name: lead
    cli: claude
    role: "Owns scope, sequencing, and acceptance"
  - name: architect
    cli: codex
    role: "Designs target architecture and migration plan"
    interactive: false
  - name: refactorer
    cli: codex
    role: "Executes scoped refactor changes"
    interactive: false
  - name: tester
    cli: claude
    role: "Validates behavior parity and risk"
workflows:
  - name: refactor-execution
    description: "Analyze current system, design approach, refactor, and validate."
    onError: retry
    steps:
      - name: analyze
        agent: architect
        task: |
          Analyze current design and identify refactor opportunities:
          {{task}}
        verification:
          type: output_contains
          value: ANALYSIS_COMPLETE
      - name: design
        agent: architect
        dependsOn: [analyze]
        task: |
          Provide incremental refactor plan with rollback notes:
          {{steps.analyze.output}}
        verification:
          type: output_contains
          value: PLAN_COMPLETE
      - name: refactor-code
        agent: refactorer
        dependsOn: [design]
        task: |
          Execute the refactor plan while preserving behavior:
          {{steps.design.output}}
        retries: 2
        verification:
          type: output_contains
          value: REFACTOR_COMPLETE
      - name: validate
        agent: tester
        dependsOn: [refactor-code]
        task: |
          Validate no regressions and ensure tests/quality checks pass:
          {{steps.refactor-code.output}}
        verification:
          type: output_contains
          value: VALIDATION_COMPLETE
      - name: handoff
        agent: lead
        dependsOn: [validate]
        task: |
          Produce final refactor summary and open follow-up items.
        verification:
          type: output_contains
          value: DONE
coordination:
  barriers:
    - name: refactor-ready
      waitFor: [analyze, design, refactor-code, validate]
      timeoutMs: 900000
state:
  backend: memory
  ttlMs: 604800000
  namespace: refactor
errorHandling:
  strategy: retry
  maxRetries: 2
  retryDelayMs: 5000
  notifyChannel: swarm-refactor
