{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "RelayYamlConfig",
  "title": "Relay YAML Configuration",
  "description": "Schema for relay.yaml workflow configuration files",
  "type": "object",
  "required": ["version", "name", "swarm", "agents"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration schema version"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for this relay configuration"
    },
    "description": {
      "type": "string",
      "description": "Optional description of the configuration"
    },
    "swarm": {
      "$ref": "#/definitions/SwarmConfig"
    },
    "agents": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/AgentDefinition"
      },
      "minItems": 1
    },
    "workflows": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/WorkflowDefinition"
      }
    },
    "coordination": {
      "$ref": "#/definitions/CoordinationConfig"
    },
    "state": {
      "$ref": "#/definitions/StateConfig"
    },
    "errorHandling": {
      "$ref": "#/definitions/ErrorHandlingConfig"
    },
    "trajectories": {
      "description": "Trajectory recording config, or false to disable trajectory output",
      "anyOf": [
        {
          "$ref": "#/definitions/TrajectoryConfig"
        },
        {
          "type": "boolean",
          "enum": [false]
        }
      ]
    }
  },
  "definitions": {
    "SwarmConfig": {
      "type": "object",
      "required": ["pattern"],
      "additionalProperties": false,
      "properties": {
        "pattern": {
          "$ref": "#/definitions/SwarmPattern"
        },
        "maxConcurrency": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of agents running concurrently"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Global swarm timeout in milliseconds"
        },
        "channel": {
          "type": "string",
          "description": "Default relay channel for agent communication"
        },
        "idleNudge": {
          "$ref": "#/definitions/IdleNudgeConfig"
        }
      }
    },
    "IdleNudgeConfig": {
      "type": "object",
      "additionalProperties": false,
      "description": "Configuration for idle agent detection and nudging",
      "properties": {
        "nudgeAfterMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Milliseconds after idle detection before first nudge (default: 120000)"
        },
        "escalateAfterMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Milliseconds after nudge before force-release (default: 120000)"
        },
        "maxNudges": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum nudges before escalation (default: 1)"
        }
      }
    },
    "SwarmPattern": {
      "type": "string",
      "enum": [
        "fan-out",
        "pipeline",
        "hub-spoke",
        "consensus",
        "mesh",
        "handoff",
        "cascade",
        "dag",
        "debate",
        "hierarchical",
        "map-reduce",
        "scatter-gather",
        "supervisor",
        "reflection",
        "red-team",
        "verifier",
        "auction",
        "escalation",
        "saga",
        "circuit-breaker",
        "blackboard",
        "swarm",
        "competitive"
      ]
    },
    "AgentDefinition": {
      "type": "object",
      "required": ["name", "cli"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique agent name within the workflow"
        },
        "cli": {
          "$ref": "#/definitions/AgentCli"
        },
        "role": {
          "type": "string",
          "description": "Agent role description"
        },
        "task": {
          "type": "string",
          "description": "Default task assigned to the agent"
        },
        "channels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Relay channels the agent should join"
        },
        "constraints": {
          "$ref": "#/definitions/AgentConstraints"
        },
        "interactive": {
          "type": "boolean",
          "default": true,
          "description": "When false, the agent runs as a non-interactive subprocess (no PTY, no relay messaging). It receives its task as a CLI prompt argument and returns stdout as output. Default: true."
        }
      }
    },
    "AgentCli": {
      "type": "string",
      "enum": ["claude", "codex", "gemini", "aider", "goose", "opencode", "droid"]
    },
    "AgentConstraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "maxTokens": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum token budget for the agent"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Per-agent timeout in milliseconds"
        },
        "retries": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of retry attempts on failure"
        },
        "model": {
          "type": "string",
          "description": "Model override for the agent"
        },
        "idleThresholdSecs": {
          "type": "integer",
          "minimum": 0,
          "description": "Seconds of inactivity before agent is considered idle (0 = disabled)"
        }
      }
    },
    "TrajectoryConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable trajectory recording"
        },
        "reflectOnBarriers": {
          "type": "boolean",
          "description": "Auto-reflect when barriers resolve"
        },
        "reflectOnConverge": {
          "type": "boolean",
          "description": "Auto-reflect when parallel tracks converge"
        },
        "autoDecisions": {
          "type": "boolean",
          "description": "Auto-record retry/skip/fail decisions"
        }
      }
    },
    "WorkflowDefinition": {
      "type": "object",
      "required": ["name", "steps"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique workflow name"
        },
        "description": {
          "type": "string"
        },
        "preflight": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/PreflightCheck"
          },
          "description": "Preflight checks that run before any steps. All must pass."
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/WorkflowStep"
          },
          "minItems": 1
        },
        "onError": {
          "type": "string",
          "enum": ["fail", "skip", "retry"],
          "description": "Error handling strategy for this workflow"
        }
      }
    },
    "PreflightCheck": {
      "type": "object",
      "required": ["command"],
      "additionalProperties": false,
      "properties": {
        "command": {
          "type": "string",
          "description": "Shell command to execute"
        },
        "failIf": {
          "type": "string",
          "description": "Fail if output matches: 'non-empty', 'empty', or a regex pattern"
        },
        "successIf": {
          "type": "string",
          "description": "Succeed only if output matches this condition"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this check validates"
        }
      }
    },
    "WorkflowStep": {
      "oneOf": [
        { "$ref": "#/definitions/AgentWorkflowStep" },
        { "$ref": "#/definitions/DeterministicWorkflowStep" },
        { "$ref": "#/definitions/WorktreeWorkflowStep" },
        { "$ref": "#/definitions/CustomWorkflowStep" }
      ]
    },
    "AgentWorkflowStep": {
      "type": "object",
      "required": ["name", "agent", "task"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["agent"],
          "description": "Step type (optional for agent steps, defaults to 'agent')"
        },
        "name": {
          "type": "string",
          "description": "Unique step name within the workflow"
        },
        "agent": {
          "type": "string",
          "description": "Name of the agent to execute this step"
        },
        "task": {
          "type": "string",
          "description": "Task description for the agent"
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step names that must complete before this step runs"
        },
        "verification": {
          "$ref": "#/definitions/VerificationCheck"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0
        },
        "retries": {
          "type": "integer",
          "minimum": 0
        },
        "maxIterations": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum iterations for steps that may need to retry"
        }
      }
    },
    "DeterministicWorkflowStep": {
      "type": "object",
      "required": ["name", "type", "command"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["deterministic"],
          "description": "Step type - must be 'deterministic' for shell command steps"
        },
        "name": {
          "type": "string",
          "description": "Unique step name within the workflow"
        },
        "command": {
          "type": "string",
          "description": "Shell command to execute. Supports {{variable}} interpolation."
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step names that must complete before this step runs"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0
        },
        "failOnError": {
          "type": "boolean",
          "default": true,
          "description": "Fail if command exit code is non-zero"
        },
        "captureOutput": {
          "type": "boolean",
          "default": true,
          "description": "Capture stdout as step output for downstream steps"
        }
      }
    },
    "WorktreeWorkflowStep": {
      "type": "object",
      "required": ["name", "type", "branch"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["worktree"],
          "description": "Step type - must be 'worktree' for git worktree setup steps"
        },
        "name": {
          "type": "string",
          "description": "Unique step name within the workflow"
        },
        "branch": {
          "type": "string",
          "description": "Branch name for the worktree. Supports {{variable}} interpolation."
        },
        "baseBranch": {
          "type": "string",
          "description": "Base branch to create the worktree from. Default: HEAD."
        },
        "path": {
          "type": "string",
          "description": "Explicit path for the worktree. Default: .worktrees/<step-name>."
        },
        "createBranch": {
          "type": "boolean",
          "default": true,
          "description": "Create the branch if it doesn't exist"
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step names that must complete before this step runs"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "CustomWorkflowStep": {
      "type": "object",
      "required": ["name", "use"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique step name within the workflow"
        },
        "use": {
          "type": "string",
          "description": "Reference to a custom step definition from .relay/steps.yaml"
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Step names that must complete before this step runs"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "CustomStepParam": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether this parameter is required"
        },
        "default": {
          "type": "string",
          "description": "Default value if not provided"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the parameter"
        }
      }
    },
    "CustomStepDefinition": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "params": {
          "type": "array",
          "items": { "$ref": "#/definitions/CustomStepParam" },
          "description": "Parameters that can be passed when using this step"
        },
        "type": {
          "type": "string",
          "enum": ["deterministic", "worktree"],
          "description": "Step type"
        },
        "command": {
          "type": "string",
          "description": "Shell command to execute (for deterministic steps)"
        },
        "branch": {
          "type": "string",
          "description": "Branch name (for worktree steps)"
        },
        "baseBranch": {
          "type": "string",
          "description": "Base branch (for worktree steps)"
        },
        "path": {
          "type": "string",
          "description": "Worktree path (for worktree steps)"
        },
        "createBranch": {
          "type": "boolean",
          "description": "Create branch if missing (for worktree steps)"
        },
        "failOnError": {
          "type": "boolean",
          "default": true,
          "description": "Fail if command exit code is non-zero"
        },
        "captureOutput": {
          "type": "boolean",
          "default": true,
          "description": "Capture stdout as step output"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Timeout in milliseconds"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this step"
        }
      }
    },
    "CustomStepsConfig": {
      "type": "object",
      "required": ["steps"],
      "additionalProperties": false,
      "properties": {
        "steps": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/CustomStepDefinition" },
          "description": "Map of step name to step definition"
        }
      }
    },
    "VerificationCheck": {
      "type": "object",
      "required": ["type", "value"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["output_contains", "exit_code", "file_exists", "custom"],
          "description": "Type of verification to perform"
        },
        "value": {
          "type": "string",
          "description": "Expected value or expression for verification"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what is being verified"
        }
      }
    },
    "CoordinationConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "barriers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Barrier"
          }
        },
        "votingThreshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of agents required for voting (0-1)"
        },
        "consensusStrategy": {
          "type": "string",
          "enum": ["majority", "unanimous", "quorum"],
          "description": "Strategy for reaching consensus among agents"
        }
      }
    },
    "Barrier": {
      "type": "object",
      "required": ["name", "waitFor"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique barrier name"
        },
        "waitFor": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Agent or step names to wait for before proceeding"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Timeout for the barrier in milliseconds"
        }
      }
    },
    "StateConfig": {
      "type": "object",
      "required": ["backend"],
      "additionalProperties": false,
      "properties": {
        "backend": {
          "type": "string",
          "enum": ["memory", "redis", "database"],
          "description": "State storage backend"
        },
        "ttlMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Time-to-live for state entries in milliseconds"
        },
        "namespace": {
          "type": "string",
          "description": "Namespace prefix for state keys"
        }
      }
    },
    "ErrorHandlingConfig": {
      "type": "object",
      "required": ["strategy"],
      "additionalProperties": false,
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["fail-fast", "continue", "retry"],
          "description": "Global error handling strategy"
        },
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of retries"
        },
        "retryDelayMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Delay between retries in milliseconds"
        },
        "notifyChannel": {
          "type": "string",
          "description": "Relay channel to notify on errors"
        }
      }
    }
  }
}
