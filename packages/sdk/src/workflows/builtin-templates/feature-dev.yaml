version: "1.0"
name: feature-dev
description: "Blueprint-style feature development with deterministic quality gates."
swarm:
  pattern: hub-spoke
  maxConcurrency: 2
  timeoutMs: 3600000
  channel: swarm-feature-dev
  idleNudge:
    nudgeAfterMs: 120000
    escalateAfterMs: 120000
    maxNudges: 1
agents:
  - name: lead
    cli: claude
    role: "Lead engineer coordinating delivery"
  - name: planner
    cli: codex
    role: "Plans implementation and acceptance criteria"
    interactive: false
  - name: developer
    cli: codex
    role: "Implements planned changes"
    interactive: false
  - name: reviewer
    cli: claude
    role: "Reviews code quality and release risk"
workflows:
  - name: feature-delivery
    description: "Plan, implement, review, and finalize a feature request with quality gates."
    onError: retry
    preflight:
      - command: git status --porcelain
        failIf: non-empty
        description: "Ensure working directory is clean"
      - command: npm run type-check 2>/dev/null || echo "skip"
        description: "Run type checking if available"
    steps:
      # Agent: Planning
      - name: plan
        type: agent
        agent: planner
        task: |
          Analyze the feature request and produce a concrete implementation plan:
          {{task}}
        retries: 1
        verification:
          type: output_contains
          value: PLAN_COMPLETE

      # Deterministic: Create feature branch
      - name: create-branch
        type: deterministic
        dependsOn: [plan]
        command: git checkout -b feature/{{branch-name}}

      # Agent: Implementation
      - name: implement
        type: agent
        agent: developer
        dependsOn: [create-branch]
        task: |
          Implement the approved plan:
          {{steps.plan.output}}
        retries: 1
        verification:
          type: output_contains
          value: IMPLEMENTATION_COMPLETE

      # Deterministic: Lint
      - name: lint
        type: deterministic
        dependsOn: [implement]
        command: npm run lint:fix 2>/dev/null || npm run lint 2>/dev/null || echo "No lint configured"

      # Deterministic: Run tests
      - name: test
        type: deterministic
        dependsOn: [lint]
        command: npm test 2>/dev/null || echo "No tests configured"

      # Agent: Fix any failures (with iteration limit)
      - name: fix-failures
        type: agent
        agent: developer
        dependsOn: [test]
        task: |
          Review test results and fix any failures. If all tests passed, output TESTS_PASSED.
          Test output: {{steps.test.output}}
        maxIterations: 2
        verification:
          type: output_contains
          value: TESTS_PASSED

      # Deterministic: Stage and commit
      - name: commit
        type: deterministic
        dependsOn: [fix-failures]
        command: 'git add -A && git commit -m "feat: {{steps.plan.output | first-line}}"'

      # Agent: Code review
      - name: review
        type: agent
        agent: reviewer
        dependsOn: [commit]
        task: |
          Review implementation quality, correctness, and test coverage:
          {{steps.implement.output}}
        verification:
          type: output_contains
          value: REVIEW_COMPLETE

      # Deterministic: Push to remote
      - name: push
        type: deterministic
        dependsOn: [review]
        command: git push origin feature/{{branch-name}}

      # Agent: Finalize
      - name: finalize
        type: agent
        agent: lead
        dependsOn: [push]
        task: |
          Summarize decisions and ship readiness for the feature.
        verification:
          type: output_contains
          value: DONE
coordination:
  barriers:
    - name: delivery-ready
      waitFor: [plan, implement, review]
      timeoutMs: 900000
state:
  backend: memory
  ttlMs: 86400000
  namespace: feature-dev
errorHandling:
  strategy: retry
  maxRetries: 2
  retryDelayMs: 5000
  notifyChannel: swarm-feature-dev
