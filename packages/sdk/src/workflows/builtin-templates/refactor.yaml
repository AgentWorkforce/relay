version: '1.0'
name: refactor
description: 'Blueprint-style refactor workflow with deterministic quality gates.'
swarm:
  pattern: hierarchical
  maxConcurrency: 2
  timeoutMs: 4500000
  channel: swarm-refactor
  idleNudge:
    nudgeAfterMs: 120000
    escalateAfterMs: 120000
    maxNudges: 1
agents:
  - name: lead
    cli: claude
    role: 'Owns scope, sequencing, and acceptance'
  - name: architect
    cli: codex
    role: 'Designs target architecture and migration plan'
    interactive: false
  - name: refactorer
    cli: codex
    role: 'Executes scoped refactor changes'
    interactive: false
  - name: tester
    cli: claude
    role: 'Validates behavior parity and risk'
workflows:
  - name: refactor-execution
    description: 'Analyze current system, design approach, refactor, and validate.'
    onError: retry
    preflight:
      - command: git status --porcelain
        failIf: non-empty
        description: 'Ensure working directory is clean'
      - command: npm test 2>/dev/null || echo "baseline"
        description: 'Capture baseline test results'
    steps:
      # Agent: Analyze current design
      - name: analyze
        type: agent
        agent: architect
        task: |
          Analyze current design and identify refactor opportunities:
          {{task}}
        verification:
          type: output_contains
          value: ANALYSIS_COMPLETE

      # Agent: Design refactor plan
      - name: design
        type: agent
        agent: architect
        dependsOn: [analyze]
        task: |
          Provide incremental refactor plan with rollback notes:
          {{steps.analyze.output}}
        verification:
          type: output_contains
          value: PLAN_COMPLETE

      # Deterministic: Create refactor branch
      - name: create-branch
        type: deterministic
        dependsOn: [design]
        command: git checkout -b refactor/{{branch-name}}

      # Agent: Execute refactor
      - name: refactor-code
        type: agent
        agent: refactorer
        dependsOn: [create-branch]
        task: |
          Execute the refactor plan while preserving behavior:
          {{steps.design.output}}
        retries: 2
        verification:
          type: output_contains
          value: REFACTOR_COMPLETE

      # Deterministic: Run linting
      - name: lint
        type: deterministic
        dependsOn: [refactor-code]
        command: npm run lint:fix 2>/dev/null || npm run lint 2>/dev/null || echo "No lint configured"

      # Deterministic: Run tests
      - name: test
        type: deterministic
        dependsOn: [lint]
        command: npm test

      # Agent: Validate behavior parity
      - name: validate
        type: agent
        agent: tester
        dependsOn: [test]
        task: |
          Validate no regressions and ensure tests/quality checks pass:
          {{steps.refactor-code.output}}
          Test results: {{steps.test.output}}
        verification:
          type: output_contains
          value: VALIDATION_COMPLETE

      # Deterministic: Commit
      - name: commit
        type: deterministic
        dependsOn: [validate]
        command: 'git add -A && git commit -m "refactor: {{steps.design.output | first-line}}"'

      # Deterministic: Push
      - name: push
        type: deterministic
        dependsOn: [commit]
        command: git push origin refactor/{{branch-name}}

      # Agent: Handoff
      - name: handoff
        type: agent
        agent: lead
        dependsOn: [push]
        task: |
          Produce final refactor summary and open follow-up items.
        verification:
          type: output_contains
          value: DONE
coordination:
  barriers:
    - name: refactor-ready
      waitFor: [analyze, design, refactor-code, validate]
      timeoutMs: 900000
state:
  backend: memory
  ttlMs: 604800000
  namespace: refactor
errorHandling:
  strategy: retry
  maxRetries: 2
  retryDelayMs: 5000
  notifyChannel: swarm-refactor
